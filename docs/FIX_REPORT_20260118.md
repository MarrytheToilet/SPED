# 数据提取问题修复报告

## 修复时间
2026-01-18

## 问题总结

### 问题1: 所有数据ID都是 AJ_20260117_001 ❌
**现象**：提取的所有JSON文件中，每个表的"数据ID"字段都是固定的 `AJ_20260117_001`

**根本原因**：
- Prompt文件中所有示例都使用了硬编码的 `AJ_20260117_001`（共29处）
- LLM在生成时直接学习并复制了这个示例值
- 虽然系统代码会生成唯一ID，但只用于外层"dataid"字段，表内的"数据ID"仍是示例值

### 问题2: 很多论文只有一条数据 ❌
**现象**：大部分论文返回的都是单条记录，即使论文中包含多个实验

**根本原因**：
- Prompt缺少多实验/多记录的明确说明和示例
- LLM倾向于将整篇论文的信息合并成一条记录
- 没有强调不同实验配置应创建独立记录的规则

---

## 修复方案

### 修复1: 数据ID占位符机制 ✅

#### 修改内容：

1. **更新Prompt文件** (`prompts/prompt.md`)
   - 将所有硬编码的 `AJ_20260117_001` 等替换为占位符 `${DATA_ID}`
   - 在Prompt开头添加明确说明：必须使用占位符
   - 共替换了29+处硬编码ID

2. **添加占位符替换函数** (`src/agents/llm_agent.py`)
   ```python
   def _replace_dataid_placeholder(self, data: Dict, actual_dataid: str) -> Dict:
       """递归替换所有 ${DATA_ID} 占位符为实际的dataid"""
   ```

3. **在提取结果处理中调用替换**
   - 在 `process_full()` 中添加占位符替换逻辑
   - 在 `process_chunk()` 中添加占位符替换逻辑
   - 确保所有记录的数据ID都被正确替换

#### 效果验证：
```bash
✅ 测试通过！
- 提取3条记录，每条的"数据ID"都是唯一的生成值
- 示例：AJ_20260118_4ba89254_9f5b6a4d
- 不再出现固定的示例ID
```

### 修复2: 多记录提取增强 ✅

#### 修改内容：

1. **在Prompt开头添加"关键说明"部分**
   - 明确数据ID占位符使用规则
   - **重点强调多记录提取规则** 🔥
   - 列出独立记录的判断标准：
     * 不同材料组合
     * 不同测试条件
     * 不同样本组
     * 不同处理工艺
     * 综述中不同文献实验

2. **添加输出格式规范章节**
   - 明确单记录和多记录的JSON格式
   - 强调即使只有1个实验也要用 `{"records": [...]}`
   - 提供清晰的格式示例

3. **添加完整的多实验示例** (ICL示例5)
   - 展示一个包含3组对比实验的论文
   - 错误输出 vs 正确输出对比
   - 明确标注关键学习点
   - 强调不要合并多个实验到一条记录

#### 效果验证：
```bash
✅ 测试通过！
- 输入：包含3个实验的测试论文
- 输出：3条独立记录
- 每条记录包含对应实验的完整数据
- 记录之间正确区分（通过"产品所属专利号或文献"字段）
```

---

## 测试结果

### 测试用例
论文包含3组对比实验：
1. 未交联PE + CoCrMo球头
2. 50kGy XLPE + CoCrMo球头
3. 100kGy XLPE + CoCrMo球头

### 测试结果
```json
{
  "count": 3,
  "records": [
    { "基本信息表": { "数据ID": "AJ_20260118_xxx" }, ... },
    { "基本信息表": { "数据ID": "AJ_20260118_xxx" }, ... },
    { "基本信息表": { "数据ID": "AJ_20260118_xxx" }, ... }
  ]
}
```

✅ **所有数据ID都已正确生成和替换**
✅ **成功识别并提取3条独立记录**
✅ **每条记录数据完整且准确**

---

## 文件变更列表

### 修改的文件：
1. `prompts/prompt.md` - Prompt模板
   - 添加关键说明章节
   - 替换所有硬编码ID为占位符
   - 添加输出格式规范
   - 添加多实验完整示例

2. `src/agents/llm_agent.py` - LLM提取Agent
   - 添加 `_replace_dataid_placeholder()` 函数
   - 在 `process_full()` 中调用替换
   - 在 `process_chunk()` 中调用替换

### 未修改的文件：
- 数据库相关代码无需修改
- 其他模块无需修改

---

## 使用建议

### 1. 重新提取已有论文
建议重新提取之前处理的论文，以获得：
- 正确的唯一数据ID
- 可能发现的额外实验记录

### 2. 检查数据库
对于已导入数据库的数据：
- 可能需要清理重复的 AJ_20260117_001
- 重新导入新提取的JSON

### 3. 批量重提取
```bash
# 方法1: 使用菜单
python menu.py
选择: 3 - 批量提取所有论文

# 方法2: 使用脚本
python scripts/extract.py batch
```

---

## 预期效果

### 问题1修复后：
- ✅ 每条记录都有唯一的数据ID
- ✅ ID格式：AJ_YYYYMMDD_hash8_uuid8
- ✅ 不再出现重复ID
- ✅ 便于数据库管理和追溯

### 问题2修复后：
- ✅ LLM能正确识别多个独立实验
- ✅ 每个实验创建独立记录
- ✅ 数据更细致、更完整
- ✅ 提高数据提取的覆盖率

---

## 后续优化建议

1. **监控提取质量**
   - 定期抽查提取结果
   - 统计平均记录数
   - 识别仍然只有单记录的论文

2. **持续优化Prompt**
   - 根据实际提取效果调整
   - 添加更多边缘案例示例
   - 优化字段提取准确度

3. **数据验证**
   - 检查数据ID唯一性
   - 验证记录数合理性
   - 审核关键字段完整性

---

## 联系方式
如有问题，请联系开发团队。
