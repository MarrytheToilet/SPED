# CSV导出格式说明

## 🎯 导出格式概述

系统现在支持JSON字段完全展开为独立列的导出方式，使CSV更符合表格数据的结构要求。

## 📊 导出格式对比

### 旧格式（展平为字符串）
```csv
实验设置
"载荷: 70.7 N; 频率: 1 Hz; 磨损轨迹路径: 12×10 mm"
```

❌ 问题：
- 数据在一个单元格中
- 无法单独筛选或分析
- 不符合表格数据结构

### 新格式（完全展开为独立列）⭐
```csv
实验设置.载荷, 实验设置.频率, 实验设置.磨损轨迹路径
70.7 N, 1 Hz, 12×10 mm
```

✅ 优势：
- 每个数据点一个列
- 可以单独筛选、排序、分析
- 符合schema定义的表格结构
- Excel/数据库友好

## 🚀 使用方法

### 方式1：命令行工具

```bash
python database.py
# 选择 7 - 快速导出所有CSV格式
```

### 方式2：统一菜单

```bash
python menu.py
# 选择 7 - 快速：导出所有CSV格式
```

### 方式3：Python API

```python
from src.database.csv_exporter import export_all_formats
from pathlib import Path

# 导出（默认展开JSON）
export_all_formats(Path("data/exports"))
```

## 📁 导出文件说明

### 1. full_data_expanded_{timestamp}.csv
**完整数据（展开JSON）⭐ 推荐**

- **特点**：JSON字段完全展开为独立列
- **字段数**：约256个（根据数据动态生成）
- **文件大小**：中等
- **适用场景**：
  - Excel分析
  - 数据库导入
  - 统计分析
  - 筛选和排序

**示例结构**：
```csv
数据id,应用部位,实验设置.载荷,实验设置.频率,实验设置.测试设备,...
AJ_001,髋关节,70.7 N,1 Hz,SuperCTPOD,...
```

### 2. full_data_raw_{timestamp}.csv
**完整数据（保留JSON）**

- **特点**：保留原始JSON字符串
- **字段数**：31个（固定）
- **文件大小**：较小
- **适用场景**：
  - 程序化处理
  - 保留完整原始数据
  - 与其他系统交互

**示例结构**：
```csv
数据id,应用部位,实验设置
AJ_001,髋关节,"{\"载荷\": \"70.7 N\", \"频率\": \"1 Hz\"}"
```

### 3. summary_{timestamp}.csv
**数据摘要**

- **特点**：每条记录的概要信息
- **字段数**：7个
- **文件大小**：最小
- **适用场景**：
  - 快速预览
  - 数据质量检查
  - 记录统计

**字段**：
- dataid
- paper_id
- 数据标识
- 应用部位
- 非空字段数
- 创建时间
- 更新时间

## 🎯 字段命名规则

### 展开后的字段命名

JSON嵌套字段使用点号(.)连接：

**原始字段**：
```
体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置
```

**JSON内容**：
```json
{
  "载荷": "70.7 N",
  "频率": "1 Hz",
  "测试设备": "SuperCTPOD",
  "磨损轨迹路径": "12×10 mm"
}
```

**展开后的字段**：
```
体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.载荷
体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.频率
体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.测试设备
体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.磨损轨迹路径
```

### 字段层级

遵循schema中的定义：

```
sheet → 大字段 → 小字段

例如：
sheet_1 → 体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置 → 载荷
```

## 💡 使用技巧

### 技巧1：Excel中使用

1. 打开`full_data_expanded_xxx.csv`
2. 使用筛选功能：选中标题行 → 数据 → 筛选
3. 可以按任意字段筛选、排序

**常用筛选**：
- 按"应用部位"筛选（髋关节/膝关节）
- 按"实验设置.载荷"排序
- 按"球头信息_球头基本信息.材料类别"分组

### 技巧2：数据分析

使用pandas处理：

```python
import pandas as pd

# 读取展开后的CSV
df = pd.read_csv('full_data_expanded_xxx.csv')

# 筛选髋关节数据
hip_data = df[df['应用部位'] == '髋关节']

# 按载荷分组统计
load_stats = df.groupby('实验设置.载荷')['数据id'].count()

# 导出特定字段
selected = df[['数据id', '应用部位', '实验设置.载荷', '实验设置.频率']]
selected.to_csv('selected_fields.csv', index=False)
```

### 技巧3：数据库导入

展开后的CSV可以直接导入到关系型数据库：

```sql
-- 创建表（PostgreSQL示例）
CREATE TABLE experiment_data (
    数据id TEXT PRIMARY KEY,
    应用部位 TEXT,
    实验设置_载荷 TEXT,
    实验设置_频率 TEXT,
    -- 更多字段...
);

-- 导入CSV
COPY experiment_data FROM 'full_data_expanded_xxx.csv' 
WITH (FORMAT CSV, HEADER TRUE, ENCODING 'UTF8');
```

## 📈 字段统计

### 展开后的字段分布

基于实际数据统计：

| 类别 | 原始字段数 | 展开后字段数 |
|------|-----------|-------------|
| 基本信息 | 3 | 3 |
| 球头信息 | 4 | ~40 |
| 内衬信息 | 6 | ~50 |
| 股骨柄信息 | 4 | ~30 |
| 体外实验 | 10 | ~120 |
| 元数据 | 4 | 4 |
| **总计** | **31** | **~256** |

### 常用字段列表

**基础字段**：
- 数据id
- paper_id
- 数据标识
- 应用部位
- 产品所属专利号或文献

**实验设置字段**（举例）：
- 体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.载荷
- 体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.频率
- 体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.测试设备
- 体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.运动形式
- 体外实验_内衬与球头摩擦腐蚀实验_内衬与球头_实验设置.循环次数

**材料字段**（举例）：
- 球头信息_球头基本信息.材料类别
- 球头信息_球头基本信息.直径
- 球头信息_球头_成分组成.Co含量
- 球头信息_球头_物理性能.硬度

**结果字段**（举例）：
- 体外实验_内衬与球头摩擦腐蚀实验_球头磨损实验结果.磨损率
- 体外实验_内衬与球头摩擦腐蚀实验_内衬磨损实验结果.磨损体积
- 体外实验_内衬与球头摩擦腐蚀实验_球头腐蚀实验结果.腐蚀电流密度

## ⚠️ 注意事项

### 1. 字段动态性

展开后的字段数量取决于实际数据：
- 不同论文可能有不同的字段
- 系统自动识别并添加所有字段
- 缺失字段填充空值

### 2. 字段名长度

某些字段名较长（如实验设置字段）：
- Excel中可能需要调整列宽
- 建议使用"冻结首行"功能
- 可以给重要字段添加注释

### 3. 空值处理

- 原始数据中的null、空字符串都转为空值
- Excel中显示为空白单元格
- 不影响筛选和排序

### 4. 编码问题

- CSV使用UTF-8编码（带BOM）
- Excel 2016+可以正确打开
- 旧版Excel可能需要导入时指定编码

## 🔄 数据流程

```
论文PDF
  ↓
MinerU解析 → full.md
  ↓
数据提取 → JSON (嵌套结构)
  ↓
数据库存储 → SQLite (JSON字符串)
  ↓
CSV导出 → 完全展开
  ↓
  ├─ full_data_expanded.csv (推荐：Excel分析)
  ├─ full_data_raw.csv (原始JSON)
  └─ summary.csv (摘要)
```

## 🎉 最佳实践

### 推荐工作流

1. **提取数据**
   ```bash
   python extract.py batch
   ```

2. **导入数据库**
   ```bash
   python database.py
   # 选择 3 - 批量导入
   ```

3. **导出展开格式**
   ```bash
   python database.py
   # 选择 7 - 导出所有CSV
   ```

4. **分析数据**
   - 打开`full_data_expanded_xxx.csv`
   - 使用Excel筛选、透视表
   - 或使用pandas/R分析

### 针对不同需求

**Excel分析** → 使用`full_data_expanded`  
**程序处理** → 使用`full_data_raw`  
**快速预览** → 使用`summary`  
**数据库导入** → 使用`full_data_expanded`

## 📞 需要帮助？

- 查看 [DATABASE_GUIDE.md](DATABASE_GUIDE.md) 了解更多数据库功能
- 查看 [README.md](../README.md) 了解系统概述

---

**开始使用**: `python database.py` → 选择 7 📤
